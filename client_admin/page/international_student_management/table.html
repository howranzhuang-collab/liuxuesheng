<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留学生管理</title>
    <link rel="stylesheet" href="../../layui/css/layui.css">
    <link rel="stylesheet" href="../../css/diy.css">
    <style>
        /* 表格字体清晰度提升 */
        .layui-table th, .layui-table td {
            color: #333 !important;
        }
        .layui-table th {
            background-color: #f2f2f2 !important;
            font-weight: bold;
        }
        .layui-table tbody tr:hover {
            background-color: #f8f8f8 !important;
        }
        .layui-table-view .layui-table {
            border: 1px solid #e6e6e6;
        }
    </style>
</head>
<body>
<div class="section1" style="padding: 20px;">
    <!-- 搜索区 -->
    <div style="background:#f8f8f8; padding:15px; border-radius:8px; margin-bottom:15px;">
        <form class="layui-form layui-form-pane" lay-filter="searchForm">
            <div class="layui-form-item">
                <div class="layui-inline">
                    <label class="layui-form-label">学生姓名</label>
                    <div class="layui-input-inline">
                        <input type="text" name="student_name" autocomplete="off" placeholder="请输入姓名" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <label class="layui-form-label">学生国籍</label>
                    <div class="layui-input-inline">
                        <input type="text" name="student_nationality" autocomplete="off" placeholder="请输入国籍" class="layui-input">
                    </div>
                </div>
                <div class="layui-inline">
                    <button type="button" class="layui-btn layui-btn-normal" id="inquire">
                        <i class="layui-icon layui-icon-search"></i> 查询
                    </button>
                    <button type="button" class="layui-btn layui-btn-warm" id="reset">
                        <i class="layui-icon layui-icon-refresh"></i> 重置
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- 操作按钮区 -->
    <div style="margin-bottom:15px;">
        <button type="button" class="layui-btn layui-btn-danger" id="batchDelete">
            <i class="layui-icon layui-icon-delete"></i> 批量删除
        </button>
        <a href="./view_add.html" class="layui-btn layui-btn-normal">
            <i class="layui-icon layui-icon-add-1"></i> 新增留学生
        </a>
    </div>

    <!-- 表格 -->
    <table class="layui-hide" id="international_student_management" lay-filter="international_student_management"></table>

    <!-- 操作列模板 -->
    <script type="text/html" id="toolbarDemo">
        <div class="layui-btn-container">
            <button class="layui-btn layui-btn-xs" lay-event="detail">查看</button>
            <button class="layui-btn layui-btn-xs layui-btn-normal" lay-event="edit">编辑</button>
            <button class="layui-btn layui-btn-xs layui-btn-danger" lay-event="del">删除</button>
        </div>
    </script>
</div>

<script src="../../layui/layui.js"></script>
<script src="../../js/axios.min.js"></script>
<script src="../../js/base.js"></script>
<script>
    const BaseUrl = baseUrl();
    axios.defaults.baseURL = BaseUrl;

    layui.use(['table', 'layer', 'form'], function(){
        const table = layui.table;
        const layer = layui.layer;
        const form = layui.form;

        const token = sessionStorage.getItem('token');

        let where = { like: 0, size: 10 };

        table.render({
            elem: '#international_student_management'
            , url: BaseUrl + '/api/international_student_management/get_list'
            , headers: { 'x-auth-token': token }
            , page: true
            , limit: 10
            , limits: [10, 20, 30, 50]
            , cols: [[
                { type: 'checkbox', fixed: 'left' }
                , { field: 'student_name', title: '学生姓名', width: 150, sort: true }
                , { field: 'student_gender', title: '学生性别', width: 100 }
                , { field: 'student_nationality', title: '学生国籍', width: 120 }
                , { field: 'overseas_universities', title: '留学院校', width: 200 }
                , { field: 'major_name', title: '专业名称', width: 180 }
                , { field: 'study_time', title: '留学时间', width: 120, templet: d => layui.util.toDateString(d.study_time, 'yyyy-MM-dd') }
                , { field: 'student_status', title: '学生学籍', width: 200 }
                , { field: 'create_time', title: '新增时间', width: 180, sort: true, templet: d => layui.util.toDateString(d.create_time, 'yyyy-MM-dd HH:mm:ss') }
                , { field: 'update_time', title: '更新时间', width: 180, sort: true, templet: d => layui.util.toDateString(d.update_time, 'yyyy-MM-dd HH:mm:ss') }
                , { fixed: 'right', title: '操作', toolbar: '#toolbarDemo', width: 200 }
            ]]
            , parseData: function(res) {
                // 你的后端成功返回 code: 200
                if (res.code === 200 && res.result) {
                    return {
                        code: 0, // Layui table 要求 code: 0 表示成功
                        msg: '',
                        count: res.result.count || 0,
                        data: res.result.list || []
                    };
                }
                // 失败或异常
                return {
                    code: 0,
                    msg: res.error?.message || '数据加载失败',
                    count: 0,
                    data: []
                };
            }
            , where: where
            , done: function(res, curr, count) {
                // 返回列表后强制刷新
                if (location.search.includes('refresh')) {
                    table.reload('international_student_management');
                }
                // 空数据提示
                if (count === 0) {
                    $('.layui-table-body').html('<div style="text-align:center;padding:50px;color:#999;font-size:16px;">暂无数据</div>');
                }
            }
        });

        // 搜索
        $('#inquire').on('click', function(){
            const formData = form.val('searchForm');
            where = { ...where, ...formData, like: 1 };
            table.reload('international_student_management', { where });
        });

        // 重置
        $('#reset').on('click', function(){
            form.val('searchForm', {});
            where = { like: 0, size: 10 };
            table.reload('international_student_management', { where });
        });

        // 批量删除（占位）
        $('#batchDelete').on('click', function(){
            const checkStatus = table.checkStatus('international_student_management');
            if (checkStatus.data.length === 0) return layer.msg('请先选择数据');
            layer.confirm(`确定删除 ${checkStatus.data.length} 条记录？`, () => {
                layer.msg('批量删除功能待实现');
            });
        });

        // 操作列事件
        table.on('tool(international_student_management)', function(obj){
            const data = obj.data;
            if(obj.event === 'detail' || obj.event === 'edit'){
                location.href = `./view_add.html?${data.international_student_management_id}`;
            } else if(obj.event === 'del'){
                layer.confirm('确定删除此条记录？', async () => {
                    try {
                        await axios.post(BaseUrl + '/api/international_student_management/del', {
                            international_student_management_id: data.international_student_management_id
                        }, { headers: { 'x-auth-token': token } });
                        layer.msg('删除成功');
                        table.reload('international_student_management');
                    } catch (e) {
                        layer.msg('删除失败');
                    }
                });
            }
        });
    });
</script>
</body>
</html>
