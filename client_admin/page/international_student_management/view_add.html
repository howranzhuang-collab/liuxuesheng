<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>留学生信息</title>
    <link rel="stylesheet" href="../../layui/css/layui.css">
    <link rel="stylesheet" href="../../css/diy.css">
</head>
<body>
<div class="warp" style="padding:20px;">
    <form class="layui-form" lay-filter="studentForm">
        <div class="layui-form-item">
            <label class="layui-form-label">学生姓名<span style="color:red;">*</span></label>
            <div class="layui-input-block">
                <input type="text" name="student_name" required lay-verify="required" placeholder="请输入学生姓名" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">学生性别</label>
            <div class="layui-input-block">
                <select name="student_gender">
                    <option value="">请选择</option>
                    <option value="男">男</option>
                    <option value="女">女</option>
                </select>
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">学生国籍</label>
            <div class="layui-input-block">
                <input type="text" name="student_nationality" placeholder="请输入学生国籍" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">留学院校</label>
            <div class="layui-input-block">
                <input type="text" name="overseas_universities" placeholder="请输入留学院校" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">专业名称</label>
            <div class="layui-input-block">
                <input type="text" name="major_name" placeholder="请输入专业名称" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">留学时间</label>
            <div class="layui-input-block">
                <input type="text" name="study_time" id="study_time" class="layui-input" placeholder="请选择留学时间">
            </div>
        </div>
        <div class="layui-form-item layui-form-text">
            <label class="layui-form-label">学生学籍</label>
            <div class="layui-input-block">
                <textarea name="student_status" placeholder="请输入学生学籍信息" class="layui-textarea"></textarea>
            </div>
        </div>

        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="submitForm">提交</button>
                <button type="button" class="layui-btn layui-btn-primary" onclick="history.back()">取消</button>
            </div>
        </div>
    </form>
</div>

<script src="../../layui/layui.js"></script>
<script src="../../js/axios.min.js"></script>
<script src="../../js/base.js"></script>
<script>
    const BaseUrl = baseUrl();
    axios.defaults.baseURL = BaseUrl;

    layui.use(['form', 'laydate', 'layer'], function(){
        const form = layui.form;
        const laydate = layui.laydate;
        const layer = layui.layer;

        const token = sessionStorage.getItem('token');
        const id = location.search.substring(1) || '';

        laydate.render({
            elem: '#study_time',
            format: 'yyyy-MM-dd'
        });

        if (id) {
            axios.get(BaseUrl + '/api/international_student_management/get_obj', {
                params: { international_student_management_id: id },
                headers: { 'x-auth-token': token }
            }).then(res => {
                if (res.data.result?.obj) {
                    const data = res.data.result.obj;
                    form.val('studentForm', {
                        student_name: data.student_name || '',
                        student_gender: data.student_gender || '',
                        student_nationality: data.student_nationality || '',
                        overseas_universities: data.overseas_universities || '',
                        major_name: data.major_name || '',
                        study_time: data.study_time ? layui.util.toDateString(data.study_time, 'yyyy-MM-dd') : '',
                        student_status: data.student_status || ''
                    });
                }
            }).catch(() => layer.msg('加载数据失败'));
        }

        form.on('submit(submitForm)', function(data){
            const loading = layer.load(1);
            const postData = data.field;

            if (postData.study_time) {
                const datePattern = /^\d{4}-\d{2}-\d{2}$/;
                if (datePattern.test(postData.study_time)) {
                    postData.study_time = postData.study_time + ' 00:00:00';
                } else {
                    postData.study_time = null;
                }
            } else {
                postData.study_time = null;
            }

            const url = id
                ? BaseUrl + '/api/international_student_management/set?international_student_management_id=' + id
                : BaseUrl + '/api/international_student_management/add';

            axios.post(url, postData, {
                headers: { 'x-auth-token': token, 'Content-Type': 'application/json' }
            }).then(res => {
                layer.close(loading);
                if (res.data.result === 1) {
                    layer.msg('操作成功', {icon: 1});
                    setTimeout(() => location.href = './table.html?refresh=' + new Date().getTime(), 1000);
                } else {
                    layer.msg(res.data.error?.message || '操作失败');
                }
            }).catch(() => {
                layer.close(loading);
                layer.msg('网络错误');
            });

            return false;
        });
    });
</script>
</body>
</html>
