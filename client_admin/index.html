<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录 - 留学生报名网站管理系统</title>
    <link rel="stylesheet" href="./layui/css/layui.css">
    <link rel="stylesheet" href="./css/diy.css">
    <script src="./js/axios.min.js"></script>
    <style>
        * { user-select: none; }
        body { background: #34495e; }
        .wrap { width: 600px; margin: 100px auto; }
        .banner {
            width: 600px; height: 400px;
            background: url(./img/5.png) no-repeat;
            background-size: 600px 400px;
            position: relative;
        }
        .blank-box {
            position: absolute; top: 100px; left: 200px;
            width: 50px; height: 50px; background: #fff;
        }
        .block {
            position: absolute; top: 100px; left: 0;
            width: 50px; height: 50px;
            background: url(./img/4.png) no-repeat;
            background-size: 600px 400px;
            background-position: -200px -100px;
            border: 1px solid red;
        }
        .move p {
            height: 50px; line-height: 50px; font-size: 16px; color: #666;
            background: #eee; text-align: center;
        }
        .move-block {
            position: absolute; left: 0; top: 0;
            width: 50px; height: 50px; background: #1abc9c; cursor: pointer;
        }
        .move {
            position: relative;
            margin-top: -50px; /* 可选，拉近滑条和图片 */
        }
        .move-block {
            position: absolute;
            left: 0;
            top: 0;
        }
    </style>
</head>
<body>

<div class="layui-container">
    <div class="layui-row">
        <div class="wrap">
            <h1 style="text-align:center;color:#fff;margin-bottom:40px;">
                留学生报名网站管理系统
            </h1>

            <form class="layui-form">
                <div class="layui-form-item">
                    <label class="layui-form-label">账号</label>
                    <div class="layui-input-block">
                        <input type="text" id="account" placeholder="用户名 / 手机 / 邮箱" autocomplete="off" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">密码</label>
                    <div class="layui-input-block">
                        <input type="password" id="password" placeholder="请输入密码" autocomplete="off" class="layui-input">
                    </div>
                </div>

                <!-- 滑动验证码 -->
                <div class="wrap">
                    <div class="banner">
                        <div class="blank-box"></div>
                        <div class="block"></div>
                    </div>
                    <div class="move">
                        <p>向右滑动完成验证 >>></p>
                        <div class="move-block"></div>
                    </div>
                </div>
            </form>

            <div class="layui-btn-container" style="text-align:center;margin-top:30px;">
                <button type="button" class="layui-btn layui-btn-lg layui-btn-normal" id="login">登录</button>
                <a href="./page/register.html" class="layui-btn layui-btn-lg layui-btn-normal">注册</a>
                <a href="./page/forgot.html" class="layui-btn layui-btn-lg layui-btn-normal">忘记密码</a>
            </div>
        </div>
    </div>
</div>

<script src="./layui/layui.js"></script>
<script src="./js/login.js"></script> <!-- 滑动验证码核心逻辑 -->
<script src="./js/base.js"></script>   <!-- 假设 baseUrl() 在这里定义 -->

<script>
    // 假设 base.js 定义了 baseUrl() 函数
    const BaseUrl = baseUrl();
    axios.defaults.baseURL = BaseUrl;

    // Axios 统一拦截器：自动添加 token + 统一错误处理
    axios.interceptors.request.use(config => {
        const token = sessionStorage.getItem('token');
        if (token) {
            config.headers['x-auth-token'] = token;
        }
        return config;
    });

    axios.interceptors.response.use(
        response => response.data,
        error => {
            layer.msg('网络错误，请检查网络后重试');
            console.error(error);
            return Promise.reject(error);
        }
    );

    // 滑动验证码成功标志（login.js 验证成功后应设置 window.k = true）
    window.k = false;

    const $account = document.getElementById('account');
    const $password = document.getElementById('password');
    const $loginBtn = document.getElementById('login');

    layui.use('layer', function () {
        const layer = layui.layer;

        // 检查 URL 是否带 token（注册后跳转回来）
        const urlParams = new URLSearchParams(window.location.search);
        const urlToken = urlParams.get('token');
        if (urlToken) {
            sessionStorage.setItem('token', urlToken);
            checkLoginStatus();
            return;
        }

        // 页面加载时检查是否已登录
        if (sessionStorage.getItem('token')) {
            checkLoginStatus();
        }

        // 统一登录函数（按钮点击 + 回车）
        async function performLogin() {
            if (!$account.value.trim()) return layer.msg('请输入账号');
            if (!$password.value) return layer.msg('请输入密码');
            if (!window.k) return layer.msg('请完成滑动验证');

            const loading = layer.load(1, { shade: [0.3, '#000'] });

            try {
                const res = await axios.post('/api/user/login', {
                    username: $account.value.trim(),
                    password: $password.value
                });

                if (res && res.result && res.result.obj) {
                    const user = res.result.obj;
                    sessionStorage.setItem('personInfo', JSON.stringify(user));
                    sessionStorage.setItem('token', user.token);

                    // 根据用户组跳转
                    const target = user.user_group === '管理员' ? './page/frime.html' : './page/user_home.html';
                    window.location.replace(target);
                } else {
                    layer.msg(res.error?.message || '登录失败');
                    $account.value = $password.value = '';
                    resetCaptcha(); // 可选：失败后重置验证码
                }
            } catch (err) {
                layer.msg('登录失败，请稍后重试');
            } finally {
                layer.close(loading);
            }
        }

        // 检查登录状态（用于自动登录）
        async function checkLoginStatus() {
            try {
                const res = await axios.get('/api/user/state');
                if (res && res.result && res.result.obj) {
                    const user = res.result.obj;
                    sessionStorage.setItem('personInfo', JSON.stringify(user));
                    sessionStorage.setItem('token', user.token);

                    const target = user.user_group === '管理员' ? './page/frime.html' : './page/user_home.html';
                    window.location.replace(target);
                }
            } catch (err) {
                sessionStorage.clear(); // token 失效清理
            }
        }

        // 按钮点击登录
        $loginBtn.onclick = performLogin;

        // 回车登录
        document.addEventListener('keydown', e => {
            if (e.key === 'Enter') {
                performLogin();
            }
        });
    });
</script>
</body>
</html>
